<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØªØ§Ø¨Ø¹ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø·Ù„Ø§Ø¨ (Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ)</title>
    <meta name="theme-color" content="#007bff"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c5f4d;
            --secondary-color: #6c757d;
            --background-color: #cde8d9;
            --surface-color: #ffffff;
            --text-color: #212529;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --font-family: 'Tajawal', sans-serif;
        }
        * { box-sizing: border-box; }
        body { font-family: var(--font-family); margin: 0; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; }
        header { background-color: var(--primary-color); color: white; padding: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .header-actions { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); display: flex; gap: 0.5rem; }
        .header-btn { background: rgba(255, 255, 255, 0.2); border: none; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.2rem; }
        .notification-badge { position: absolute; top: -5px; right: -5px; background-color: var(--danger-color); color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.8rem; display: none; align-items: center; justify-content: center; }
        main { padding: 1rem; max-width: 800px; margin: 0 auto; padding-bottom: 80px; }
        section { background-color: var(--surface-color); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        h2 { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 0.5rem; margin-top: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem; }
        h2 i { font-size: 1.4rem; }
        button, .btn { background-color: var(--primary-color); color: white; border: none; padding: 0.75rem 1rem; border-radius: 5px; cursor: pointer; font-family: var(--font-family); font-size: 1rem; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 2px solid transparent; text-decoration: none; }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-warning { background-color: var(--warning-color); color: #212529;}
        .student-card { background-color: #fdfdff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; }
        .student-name-link { font-weight: bold; cursor: pointer; color: var(--primary-color); text-decoration: underline; }
        .attendance-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; margin-top: 0.5rem; }
        .attendance-btn { padding: 0.5rem; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; text-align: center; display: flex; align-items: center; justify-content: center; gap: 0.25rem; border: 2px solid transparent; }
        .attendance-btn.active { font-weight: bold; transform: scale(1.05); box-shadow: 0 0 0 2px white; }
        input, select { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 5px; font-family: var(--font-family); font-size: 1rem; margin-bottom: 0.5rem; }
        #date-display .today-indicator { background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px; }
        footer { text-align: center; padding: 1rem; color: var(--secondary-color); font-size: 0.9rem; background-color: var(--surface-color); border-top: 1px solid #eee; position: fixed; bottom: 0; width: 100%; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; background-color: rgba(0,0,0,0.5); display: none; }
        .overlay.visible { display: flex; align-items: center; justify-content: center; }
        .sidebar { right: -320px; left: auto; width: 320px; background-color: var(--surface-color); box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; padding: 1rem; position: fixed; top: 0; height: 100%; z-index: 1000; overflow-y: auto; }
        .sidebar.open { right: 0; }
        .modal-content { background: white; padding: 1.5rem; border-radius: 8px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .master-student-item > div, .status-item-row > div { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .hidden { display: none; }
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
    </style>
</head>
<body>
    <header>
        <div class="header-actions"><button class="header-btn" id="notifications-btn"><i class="fas fa-bell"></i><span class="notification-badge" id="notification-count">0</span></button></div>
        <h1>Ù…ØªØ§Ø¨Ø¹ Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
    </header>
    <main>
        <section id="settings"><h2><i class="fas fa-cogs"></i> Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2><div style="display: grid; grid-template-columns: 1fr 2fr; gap: 0.5rem; margin-bottom: 0.5rem;"><input type="text" id="institution-type" placeholder="Ù†ÙˆØ¹ Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ù…Ø³Ø¬Ø¯ØŒ Ø¯Ø§Ø±...)"><input type="text" id="institution-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø© (Ø§Ù„ØµØ­Ø§Ø¨Ø©...)"></div><input type="text" id="teacher-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°...">
<div style="margin-top: 0.5rem;">
    <label for="gender-template-select">Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª:</label>
    <select id="gender-template-select" style="width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 5px; font-family: var(--font-family); font-size: 1rem;">
        <option value="male" selected>Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù…Ø°ÙƒØ±)</option>
        <option value="female">Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª (Ù…Ø¤Ù†Ø«)</option>
    </select>
    <p style="font-size: 0.8rem; color: var(--secondary-color); margin-top: 0.25rem;">Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø§Ù„Ø¨ØŒ Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª" Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©" Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯.</p>
</div><button id="save-settings-btn" class="btn-success" style="width: 100%; margin-top: 0.5rem;"><i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button><div style="margin-top: 1rem; display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem;"><button id="manage-statuses-btn" class="btn"><i class="fas fa-tags"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª</button><button id="refresh-data-btn" class="btn-secondary"><i class="fas fa-sync-alt"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button><button id="factory-reset-btn" class="btn-danger"><i class="fas fa-trash-alt"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø·</button></div></section>
        <section id="date-management"><h2><i class="fas fa-calendar-alt"></i> Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ®</h2><div style="display: flex; gap: 0.5rem; align-items: center;"><input type="date" id="current-date" style="flex-grow: 1;"><button id="today-btn"><i class="fas fa-calendar-day"></i></button></div><div id="date-display" style="text-align: center; margin: 1rem 0; font-weight: bold; color: var(--primary-color);"></div><div style="display: flex; gap: 0.5rem;"><button id="prev-day-btn" style="flex: 1;"><i class="fas fa-arrow-right"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button><button id="next-day-btn" style="flex: 1;">Ø§Ù„ØªØ§Ù„ÙŠ <i class="fas fa-arrow-left"></i></button></div></section>
        <section id="student-management"><h2><i class="fas fa-users"></i> Ø§Ù„Ø·Ù„Ø§Ø¨ (<span id="registered-count">0</span>)</h2><div id="student-list-container"></div><div style="margin-top: 1rem;"><button id="manage-students-btn" class="btn"><i class="fas fa-user-edit"></i> Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</button></div></section>
        <section id="actions"><h2><i class="fas fa-cogs"></i> Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2><label for="message-template-select">Ù‚Ø§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:</label><select id="message-template-select"><option value="grouped" selected>Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©</option><option value="detailed">Ù…ÙØµÙ„</option><option value="summary">Ù…Ù„Ø®Øµ</option></select><button id="generate-whatsapp-btn" class="btn-success" style="width: 100%; margin-top: 1rem;"><i class="fab fa-whatsapp"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</button><div style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;"><button id="print-report-btn" class="btn"><i class="fas fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±</button><button id="export-csv-btn" class="btn"><i class="fas fa-file-csv"></i> ØªØµØ¯ÙŠØ± Excel</button></div><div id="backup-restore-controls" style="margin-top: 1rem; border-top: 1px solid #eee; padding-top: 1rem; display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;"><button id="backup-btn" class="btn-secondary"><i class="fas fa-download"></i> ØªÙ†Ø²ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button><button id="restore-btn" class="btn-secondary"><i class="fas fa-upload"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†Ø³Ø®Ø©</button><input type="file" id="restore-file-input" class="hidden" accept=".json">
</div></section>
        <section id="whatsapp-output-section" class="hidden"><h2>Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù…Ù†Ø³Ù‚Ø©</h2><textarea id="whatsapp-output" readonly style="width: 100%; min-height: 150px; border: 1px solid #ccc; border-radius: 5px; padding: 0.5rem; font-family: monospace; font-size: 0.9rem; white-space: pre; background-color: #e9ecef; direction: ltr; text-align: left; margin-top: 1rem;"></textarea><div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;"><button id="copy-whatsapp-msg-btn" class="btn-info"><i class="fas fa-copy"></i> Ù†Ø³Ø®</button><button id="share-whatsapp-btn" style="background-color: #25d366; color: white;"><i class="fab fa-whatsapp"></i> Ù…Ø´Ø§Ø±ÙƒØ©</button></div></section>
        <section id="statistics-section">
            <h2><i class="fas fa-chart-pie"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ©</h2>
            <div style="display: flex; gap: 1rem; align-items: center; margin-bottom: 1rem;">
                <label for="stats-start-date">Ù…Ù†:</label>
                <input type="date" id="stats-start-date" style="flex-grow: 1;">
                <label for="stats-end-date">Ø¥Ù„Ù‰:</label>
                <input type="date" id="stats-end-date" style="flex-grow: 1;">
            </div>
            <button id="generate-stats-btn" class="btn" style="width: 100%;"><i class="fas fa-calculator"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠ</button>
            <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1rem;">
                <input type="number" id="stats-last-days" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù…" style="width: 120px;">
                <button id="generate-stats-last-days-btn" class="btn" style="flex-grow: 1;">ØªÙ‚Ø±ÙŠØ± Ù„Ø¢Ø®Ø± 'Ù†' ÙŠÙˆÙ…</button>
            </div>
            <div id="statistics-output" style="margin-top: 1rem; white-space: pre-wrap; background-color: #e9ecef; padding: 1rem; border-radius: 5px; direction: ltr; text-align: left; display: none;"></div>
            <div id="stats-actions-container" style="display: none; flex-direction: column; gap: 0.5rem; margin-top: 1rem;">
                <button id="copy-stats-btn" class="btn btn-info"><i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button id="share-stats-btn" class="btn" style="background-color: #25d366; color: white;"><i class="fab fa-whatsapp"></i> Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button>
            </div>
        </section>
    </main>

    <!-- Modals & Sidebars -->
    <div class="overlay" id="main-overlay"></div>
    <div class="sidebar" id="notifications-sidebar"><div class="sidebar-header"><h2 class="sidebar-title">Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h2><button class="close-sidebar" id="close-notifications"><i class="fas fa-times"></i></button></div><div id="notifications-list"></div></div>
    <div class="overlay" id="student-modal-overlay"><div class="modal-content"><h2>Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</h2><div id="master-student-list"></div><hr><form id="add-student-form" style="display: flex; gap: 0.5rem; margin-top: 1rem;"><input type="text" id="new-student-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯..." required style="flex-grow: 1;"><button type="submit" class="btn-success"><i class="fas fa-plus"></i> Ø¥Ø¶Ø§ÙØ©</button></form><button id="close-student-modal" class="btn-secondary" style="width: 100%; margin-top: 1rem;">Ø¥ØºÙ„Ø§Ù‚</button></div></div>
    <div class="overlay" id="statuses-modal-overlay"><div class="modal-content"><h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2><div id="statuses-list"></div><hr><button id="reset-statuses-btn" class="btn-warning" style="width:100%; margin-bottom: 1rem;"><i class="fas fa-sync"></i> Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</button><form id="add-status-form" style="margin-top: 1rem;"><h3>Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3><input type="text" id="new-status-label" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„Ø© (Ù…Ø«Ø§Ù„: Ù…ØªÙ…ÙŠØ²)" required><input type="text" id="new-status-symbol" placeholder="Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© (Ù…Ø«Ø§Ù„: ğŸŒŸ)" required><label for="new-status-color">Ø§Ù„Ù„ÙˆÙ†:</label><input type="color" id="new-status-color" value="#007bff" style="padding: 0.2rem; height: 40px;"><button type="submit" class="btn-success" style="width: 100%; margin-top: 1rem;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø©</button></form><button id="close-statuses-modal" class="btn-secondary" style="width: 100%; margin-top: 1rem;">Ø¥ØºÙ„Ø§Ù‚</button></div></div>
    <div class="overlay" id="student-profile-modal-overlay"><div class="modal-content"><h2 id="student-profile-title"></h2><div id="student-profile-content"></div><button id="close-student-profile-modal" class="btn-secondary" style="width: 100%; margin-top: 1rem;">Ø¥ØºÙ„Ø§Ù‚</button></div></div>

    <footer><p>ØµÙ†Ø¹ Ø¨ÙˆØ§Ø³Ø·Ø© ØªØ±Ø³ Ø§Ù„Ø´ÙØ±Ø©-1</p></footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const $ = (id) => document.getElementById(id);
                const allSelectors = {
                    studentListContainer: $("student-list-container"),
                    notificationsBtn: $("notifications-btn"),
                    notificationCountBadge: $("notification-count"),
                    notificationsList: $("notifications-list"),
                    notificationsSidebar: $("notifications-sidebar"),
                    closeNotifications: $("close-notifications"),
                    mainOverlay: $("main-overlay"),
                    institutionTypeInput: $("institution-type"),
                    institutionNameInput: $("institution-name"),
                    teacherNameInput: $("teacher-name"),
                    saveSettingsBtn: $("save-settings-btn"),
                    currentDateInput: $("current-date"),
                    dateDisplay: $("date-display"),
                    todayBtn: $("today-btn"),
                    prevDayBtn: $("prev-day-btn"),
                    nextDayBtn: $("next-day-btn"),
                    generateWhatsappBtn: $("generate-whatsapp-btn"),
                    whatsappOutputSection: $("whatsapp-output-section"),
                    whatsappOutput: $("whatsapp-output"),
                    copyWhatsappMsgBtn: $("copy-whatsapp-msg-btn"),
                    shareWhatsappBtn: $("share-whatsapp-btn"),
                    messageTemplateSelect: $("message-template-select"),
                    registeredCountEl: $("registered-count"),
                    backupBtn: $("backup-btn"),
                    restoreBtn: $("restore-btn"),
                    restoreFileInput: $("restore-file-input"),
                    manageStudentsBtn: $("manage-students-btn"),
                    studentModalOverlay: $("student-modal-overlay"),
                    masterStudentListContainer: $("master-student-list"),
                    addStudentForm: $("add-student-form"),
                    newStudentNameInput: $("new-student-name"),
                    closeStudentModalBtn: $("close-student-modal"),
                    manageStatusesBtn: $("manage-statuses-btn"),
                    statusesModalOverlay: $("statuses-modal-overlay"),
                    statusesListContainer: $("statuses-list"),
                    addStatusForm: $("add-status-form"),
                    newStatusLabelInput: $("new-status-label"),
                    newStatusSymbolInput: $("new-status-symbol"),
                    newStatusColorInput: $("new-status-color"),
                    closeStatusesModalBtn: $("close-statuses-modal"),
                    resetStatusesBtn: $("reset-statuses-btn"),
                    studentProfileModalOverlay: $("student-profile-modal-overlay"),
                    studentProfileTitle: $("student-profile-title"),
                    studentProfileContent: $("student-profile-content"),
                                closeStudentProfileModalBtn: $("close-student-profile-modal"),
                                printReportBtn: $("print-report-btn"),
                                exportCsvBtn: $("export-csv-btn"),
                                refreshDataBtn: $("refresh-data-btn"),
                                factoryResetBtn: $("factory-reset-btn"),
                                genderTemplateSelect: $("gender-template-select"),
                                statsStartDate: $("stats-start-date"),
                                statsEndDate: $("stats-end-date"),
                                generateStatsBtn: $("generate-stats-btn"),
                                statisticsOutput: $("statistics-output"),
                                statsLastDays: $("stats-last-days"),
                                generateStatsLastDaysBtn: $("generate-stats-last-days-btn"),
                                statsActionsContainer: $("stats-actions-container"),
                                copyStatsBtn: $("copy-stats-btn"),
                                shareStatsBtn: $("share-stats-btn")
                            };
                    
                            const STORAGE_KEYS = {
                                MASTER_LIST: 'studentTracker_v2_masterList',
                                ALL_DATA: 'studentTracker_v2_allData',
                                STATUSES: 'studentTracker_v2_statuses',
                                SETTINGS: 'mosqueSettings_v2'
                            };
                    
                            const DEFAULT_STATUSES = [
                                { key: 'excellent', label: 'Ø£Ù†Ø¬Ø² Ø¨ØªÙ…ÙŠØ².', symbol: 'ğŸŒŸ', color: '#ffc107', notification: { enabled: true, days: 3 } },
                                { key: 'completed_full', label: 'Ø£Ù†Ø¬Ø² Ø§Ù„Ù…Ù‚Ø±Ø± (Ø§Ù„Ø¯Ø±Ø³ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©).', symbol: 'âœ…', color: '#28a745', notification: { enabled: false, days: 2 } },
                                { key: 'completed_partial', label: 'Ø£Ù†Ø¬Ø² Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù…Ù‚Ø±Ø±.', symbol: 'â˜‘ï¸', color: '#17a2b8', notification: { enabled: false, days: 2 } },
                                { key: 'absent_unexcused', label: 'ØºØ§Ø¦Ø¨ Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±.', symbol: 'ğŸ”´', color: '#dc3545', notification: { enabled: true, days: 2 } },
                                { key: 'absent_excused', label: 'Ù…Ø³ØªØ£Ø°Ù†.', symbol: 'ğŸŸ ', color: '#fd7e14', notification: { enabled: false, days: 3 } },
                                { key: 'not_completed', label: 'Ù„Ù… ÙŠÙ†Ø¬Ø² Ø§Ù„Ù…Ù‚Ø±Ø±.', symbol: 'âŒ', color: '#6c757d', notification: { enabled: true, days: 2 } }
                            ];
                    
                            const DEFAULT_STATUSES_FEMALE = [
                                { key: 'excellent', label: 'Ø£Ù†Ø¬Ø²Øª Ø¨ØªÙ…ÙŠØ².', symbol: 'ğŸŒŸ', color: '#ffc107', notification: { enabled: true, days: 3 } },
                                { key: 'completed_full', label: 'Ø£Ù†Ø¬Ø²Øª Ø§Ù„Ù…Ù‚Ø±Ø± (Ø§Ù„Ø¯Ø±Ø³ ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©).', symbol: 'âœ…', color: '#28a745', notification: { enabled: false, days: 2 } },
                                { key: 'completed_partial', label: 'Ø£Ù†Ø¬Ø²Øª Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù…Ù‚Ø±Ø±.', symbol: 'â˜‘ï¸', color: '#17a2b8', notification: { enabled: false, days: 2 } },
                                { key: 'absent_unexcused', label: 'ØºØ§Ø¦Ø¨Ø© Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±.', symbol: 'ğŸ”´', color: '#dc3545', notification: { enabled: true, days: 2 } },
                                { key: 'absent_excused', label: 'Ù…Ø³ØªØ£Ø°Ù†Ø©.', symbol: 'ğŸŸ ', color: '#fd7e14', notification: { enabled: false, days: 3 } },
                                { key: 'not_completed', label: 'Ù„Ù… ØªÙ†Ø¬Ø² Ø§Ù„Ù…Ù‚Ø±Ø±.', symbol: 'âŒ', color: '#6c757d', notification: { enabled: true, days: 2 } }
                            ];
                    
                            let ATTENDANCE_OPTIONS = [];
                            let students = []; // This is the daily view model, a result of joining master list and daily data
                            let studentMasterList = []; // Array of {id, name}
                            let allDateData = {}; // Object of { date: { studentId: { status: [] } } }
                            let currentDate = '';
                    
                            function saveState() {
                                if (currentDate) {
                                    const todaysData = {};
                                    students.forEach(student => {
                                        if (student.status && student.status.length > 0) {
                                            todaysData[student.id] = { status: student.status };
                                        }
                                    });
                                    if (Object.keys(todaysData).length > 0) {
                                        allDateData[currentDate] = todaysData;
                                    } else {
                                        delete allDateData[currentDate]; // Clean up empty dates
                                    }
                                }
                                localStorage.setItem(STORAGE_KEYS.ALL_DATA, JSON.stringify(allDateData));
                                localStorage.setItem(STORAGE_KEYS.MASTER_LIST, JSON.stringify(studentMasterList));
                                localStorage.setItem(STORAGE_KEYS.STATUSES, JSON.stringify(ATTENDANCE_OPTIONS));
                            }
                    
                            function loadState() {
                                try {
                                    const storedAllData = localStorage.getItem(STORAGE_KEYS.ALL_DATA);
                                    const storedMasterList = localStorage.getItem(STORAGE_KEYS.MASTER_LIST);
                                    const storedStatuses = localStorage.getItem(STORAGE_KEYS.STATUSES);
                                    const storedSettings = localStorage.getItem(STORAGE_KEYS.SETTINGS);
                    
                                    allDateData = storedAllData ? JSON.parse(storedAllData) : {};
                                    studentMasterList = storedMasterList ? JSON.parse(storedMasterList) : [];
                                    
                                    let settings = storedSettings ? JSON.parse(storedSettings) : {};
                                    // Migration from old settings format
                                    if (settings.mosqueName && !settings.institutionName) {
                                        settings.institutionName = settings.mosqueName;
                                        settings.institutionType = 'Ù…Ø³Ø¬Ø¯'; // Default type for migration
                                        delete settings.mosqueName;
                                        localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings)); // Re-save in new format
                                    }
                                    allSelectors.institutionTypeInput.value = settings.institutionType || '';
                                    allSelectors.institutionNameInput.value = settings.institutionName || '';
                                    allSelectors.teacherNameInput.value = settings.teacherName || '';
                                    allSelectors.genderTemplateSelect.value = settings.genderTemplate || 'male';
                    
                                    if (storedStatuses) {
                                        ATTENDANCE_OPTIONS = JSON.parse(storedStatuses);
                                    } else {
                                        const template = settings.genderTemplate || 'male';
                                        ATTENDANCE_OPTIONS = template === 'female'
                                            ? JSON.parse(JSON.stringify(DEFAULT_STATUSES_FEMALE))
                                            : JSON.parse(JSON.stringify(DEFAULT_STATUSES));
                                    }
                    
                                    ATTENDANCE_OPTIONS.forEach(opt => { 
                                        if (typeof opt.notification !== 'object') opt.notification = { enabled: false, days: 2 }; 
                                    });
                    
                                } catch (e) {
                                    console.error("Failed to load state from localStorage", e);
                                    alert("ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©. Ù‚Ø¯ ØªÙƒÙˆÙ† ØªØ§Ù„ÙØ©.");
                                }
                            }
                    
                            function saveSettings() {
                                const institutionType = allSelectors.institutionTypeInput.value.trim();
                                const institutionName = allSelectors.institutionNameInput.value.trim();
                                const teacherName = allSelectors.teacherNameInput.value.trim();
                                const genderTemplate = allSelectors.genderTemplateSelect.value;
                    
                                allSelectors.institutionTypeInput.value = institutionType;
                                allSelectors.institutionNameInput.value = institutionName;
                                allSelectors.teacherNameInput.value = teacherName;
                    
                                const settings = { 
                                    institutionType: institutionType,
                                    institutionName: institutionName, 
                                    teacherName: teacherName,
                                    genderTemplate: genderTemplate
                                };
                                localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
                                alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª!');
                            }
                    
                            function setCurrentDate(dateString) {
                                if (!dateString) return;
                                saveState();
                                currentDate = dateString;
                                allSelectors.currentDateInput.value = currentDate;
                                loadStudentsForDate(currentDate);
                                updateDateDisplay();
                                renderStudents();
                                checkAndDisplayNotifications();
                            }
                    
                            function loadStudentsForDate(dateString) {
                                const todaysData = allDateData[dateString] || {};
                                students = studentMasterList.map(masterStudent => {
                                    const studentDataForToday = todaysData[masterStudent.id] || { status: [] };
                                    return {
                                        ...masterStudent, // Contains id and name
                                        status: JSON.parse(JSON.stringify(studentDataForToday.status)) // Deep copy
                                    };
                                });
                            }
                    
                            function updateDateDisplay() {
                                const dateObj = new Date(currentDate + 'T00:00:00');
                                const today = new Date().toISOString().split('T')[0];
                                let formattedDate = dateObj.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                                if (currentDate === today) formattedDate = `<span class="today-indicator">Ø§Ù„ÙŠÙˆÙ…</span> ${formattedDate}`;
                                allSelectors.dateDisplay.innerHTML = formattedDate;
                            }
                    
                            function navigateDate(direction) {
                                const parts = currentDate.split('-').map(Number);
                                // Month is 0-indexed in JavaScript Date, so parts[1] - 1
                                const dateObj = new Date(parts[0], parts[1] - 1, parts[2]);
                                dateObj.setDate(dateObj.getDate() + direction);
                                
                                const year = dateObj.getFullYear();
                                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                                const day = String(dateObj.getDate()).padStart(2, '0');
                                const newDate = `${year}-${month}-${day}`;
                    
                                setCurrentDate(newDate);
                            }
                    
                            function toggleStudentStatus(studentId, statusKey) {
                                const student = students.find(s => s.id === studentId);
                                if (!student) return;
                                if (!student.status) student.status = [];
                    
                                const isAlreadyActive = student.status[0] === statusKey;
                    
                                if (isAlreadyActive) {
                                    // If the clicked button is already the active one, deactivate it.
                                    student.status = [];
                                } else {
                                    // Otherwise, set the clicked button as the one and only active status.
                                    student.status = [statusKey];
                                }
                    
                                saveState();
                                renderStudents();
                                checkAndDisplayNotifications();
                            }
                    
                            function renderStudents() {
                                allSelectors.studentListContainer.innerHTML = '';
                                allSelectors.registeredCountEl.textContent = studentMasterList.length;
                    
                                if (studentMasterList.length === 0) {
                                    const emptyStateHTML = `
                                        <div style="text-align: center; padding: 2rem; color: var(--secondary-color);">
                                            <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                            <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙˆÙ† Ø¨Ø¹Ø¯.</p>
                                            <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø¥Ø¯Ø§Ø±Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨" Ù„Ø¥Ø¶Ø§ÙØ© Ø£ÙˆÙ„ Ø·Ø§Ù„Ø¨.</p>
                                        </div>
                                    `;
                                    allSelectors.studentListContainer.innerHTML = emptyStateHTML;
                                    return;
                                }
                    
                                students.forEach(student => {
                                    const studentCard = document.createElement('div');
                                    studentCard.className = 'student-card';
                                    const studentNameEl = document.createElement('div');
                                    studentNameEl.className = 'student-name-link';
                                    studentNameEl.textContent = student.name;
                                    studentNameEl.onclick = () => openStudentProfile(student.id);
                                    const controlsContainer = document.createElement('div');
                                    controlsContainer.className = 'attendance-controls';
                                    ATTENDANCE_OPTIONS.forEach(option => {
                                        const btn = document.createElement('button');
                                        btn.className = 'attendance-btn';
                                        const isActive = student.status && student.status.includes(option.key);
                                        
                                        btn.style.backgroundColor = isActive ? option.color : '#cccccc'; // Lighter grey for inactive
                                        btn.style.color = 'white';
                                        
                                        if (isActive) {
                                            btn.classList.add('active');
                                        }
                                        
                                        btn.innerHTML = `${option.symbol} ${option.label}`;
                                        btn.onclick = () => toggleStudentStatus(student.id, option.key);
                                        controlsContainer.appendChild(btn);
                                    });
                                    studentCard.appendChild(studentNameEl);
                                    studentCard.appendChild(controlsContainer);
                                    allSelectors.studentListContainer.appendChild(studentCard);
                                });
                            }
                    
                            function openModal(modalOverlay) { modalOverlay.classList.add('visible'); allSelectors.mainOverlay.classList.add('visible'); }
                            function closeModal(modalOverlay) { modalOverlay.classList.remove('visible'); allSelectors.mainOverlay.classList.remove('visible'); }
                    
                            function renderMasterStudentList() {
                                allSelectors.masterStudentListContainer.innerHTML = '';
                                studentMasterList.forEach(student => {
                                    const itemDiv = document.createElement('div');
                                    itemDiv.className = 'master-student-item';
                                    itemDiv.style = 'padding: 0.5rem; border-bottom: 1px solid #eee;';
                                    const viewMode = document.createElement('div');
                                    viewMode.className = 'view-mode';
                                    viewMode.innerHTML = `<span>${student.name}</span><div><button class="btn-secondary btn-edit" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">ØªØ¹Ø¯ÙŠÙ„</button><button class="btn-danger btn-delete" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Ø­Ø°Ù</button></div>`;
                                    const editMode = document.createElement('div');
                                    editMode.className = 'edit-mode';
                                    editMode.style.display = 'none';
                                    editMode.innerHTML = `<input type="text" value="${student.name}" style="flex-grow: 1;"><div><button class="btn-success btn-save" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Ø­ÙØ¸</button><button class="btn-secondary btn-cancel" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Ø¥Ù„ØºØ§Ø¡</button></div>`;
                                    itemDiv.appendChild(viewMode);
                                    itemDiv.appendChild(editMode);
                                    allSelectors.masterStudentListContainer.appendChild(itemDiv);
                                    itemDiv.querySelector('.btn-edit').onclick = () => { viewMode.style.display = 'none'; editMode.style.display = 'flex'; };
                                    itemDiv.querySelector('.btn-cancel').onclick = () => { viewMode.style.display = 'flex'; editMode.style.display = 'none'; };
                                    itemDiv.querySelector('.btn-delete').onclick = () => deleteFromMasterList(student.id);
                                    itemDiv.querySelector('.btn-save').onclick = () => handleEditStudent(student.id, itemDiv.querySelector('input').value.trim());
                                });
                            }
                    
                            function handleEditStudent(studentId, newName) {
                                if (!newName) { renderMasterStudentList(); return; }
                                const studentToUpdate = studentMasterList.find(s => s.id === studentId);
                                if (!studentToUpdate) return;
                    
                                const isDuplicate = studentMasterList.some(s => s.name === newName && s.id !== studentId);
                                if (isDuplicate) {
                                    alert('Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„.');
                                    return;
                                }
                    
                                studentToUpdate.name = newName;
                                saveState();
                                loadStudentsForDate(currentDate);
                                renderStudents();
                                renderMasterStudentList();
                            }
                    
                            function deleteFromMasterList(studentId) {
                                const studentToDelete = studentMasterList.find(s => s.id === studentId);
                                if (!studentToDelete) return;
                    
                                if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨ "${studentToDelete.name}"? Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§ØªÙ‡.`)) {
                                    studentMasterList = studentMasterList.filter(s => s.id !== studentId);
                                    Object.keys(allDateData).forEach(date => {
                                        delete allDateData[date][studentId];
                                    });
                                    saveState();
                                    loadStudentsForDate(currentDate);
                                    renderStudents();
                                    renderMasterStudentList();
                                }
                            }
                    
                            function renderStatusesList() {
                                allSelectors.statusesListContainer.innerHTML = '';
                                ATTENDANCE_OPTIONS.forEach(status => {
                                    const itemWrapper = document.createElement('div');
                                    itemWrapper.style.padding = '0.5rem';
                                    itemWrapper.style.borderBottom = '1px solid #eee';
                                    const statusRow = document.createElement('div');
                                    statusRow.className = 'status-item-row';
                    
                                    const isProtected = status.key === 'absent_unexcused' || status.key === 'absent_excused';
                                    const deleteBtnHTML = isProtected
                                        ? `<button class="btn-secondary" style="padding: 0.2rem 0.5rem; font-size: 0.8rem; opacity: 0.6; cursor: not-allowed;" disabled>Ø£Ø³Ø§Ø³ÙŠ</button>`
                                        : `<button class="btn-danger btn-delete-status" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;">Ø­Ø°Ù</button>`;
                    
                                    statusRow.innerHTML = `<div><span style="display: inline-block; width: 20px; height: 20px; background-color: ${status.color}; border-radius: 50%; margin-left: 10px;"></span><strong>${status.label}</strong> (${status.symbol})</div><div><button class="btn-secondary btn-notif-settings" style="padding: 0.2rem 0.5rem; font-size: 0.8rem;"><i class="fas fa-cog"></i></button>${deleteBtnHTML}</div>`;
                                    
                                    const settingsDiv = document.createElement('div');
                                    settingsDiv.className = 'notification-settings-panel';
                                    settingsDiv.style.display = 'none';
                                    settingsDiv.style.padding = '0.5rem';
                                    settingsDiv.style.marginTop = '0.5rem';
                                    settingsDiv.style.backgroundColor = '#f8f9fa';
                                    settingsDiv.innerHTML = `<label style="display: flex; align-items: center; gap: 0.5rem;"><input type="checkbox" class="notif-enabled" ${status.notification.enabled ? 'checked' : ''}> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©</label><div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;"><span>ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø¹Ø¯:</span><input type="number" class="notif-days" value="${status.notification.days}" min="2" style="width: 60px;"><span>Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©</span></div>`;
                                    
                                    itemWrapper.appendChild(statusRow);
                                    itemWrapper.appendChild(settingsDiv);
                                    allSelectors.statusesListContainer.appendChild(itemWrapper);
                                    
                                    itemWrapper.querySelector('.btn-notif-settings').onclick = () => { settingsDiv.style.display = settingsDiv.style.display === 'none' ? 'block' : 'none'; };
                                    
                                    if (!isProtected) {
                                        itemWrapper.querySelector('.btn-delete-status').onclick = () => deleteStatus(status.key);
                                    }
                    
                                    const enabledCheckbox = itemWrapper.querySelector('.notif-enabled');
                                    const daysInput = itemWrapper.querySelector('.notif-days');
                                    enabledCheckbox.onchange = () => { status.notification.enabled = enabledCheckbox.checked; saveState(); };
                                    daysInput.onchange = () => { status.notification.days = parseInt(daysInput.value) || 2; saveState(); };
                                });
                            }
                    
                            function deleteStatus(keyToDelete) {
                                if (ATTENDANCE_OPTIONS.length <= 2) { alert('ÙŠØ¬Ø¨ Ø£Ù† ØªØ¨Ù‚Ù‰ Ø­Ø§Ù„ØªØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'); return; }
                                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø©ØŸ')) {
                                    ATTENDANCE_OPTIONS = ATTENDANCE_OPTIONS.filter(s => s.key !== keyToDelete);
                                    saveState();
                                    renderStatusesList();
                                }
                            }
                            
                            function resetStatusesToDefault() {
                                if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‚Ø§Ø¦Ù…ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø¨Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.')) {
                                    const template = allSelectors.genderTemplateSelect.value;
                                    ATTENDANCE_OPTIONS = template === 'female'
                                        ? JSON.parse(JSON.stringify(DEFAULT_STATUSES_FEMALE))
                                        : JSON.parse(JSON.stringify(DEFAULT_STATUSES));
                                    saveState();
                                    renderStatusesList();
                                    renderStudents();
                                }
                            }
        
                function openStudentProfile(studentId) {
                    const student = studentMasterList.find(s => s.id === studentId);
                    if (!student) return;
                    allSelectors.studentProfileTitle.innerHTML = `<i class="fas fa-user-circle"></i> Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}`;
                    const history = getStudentHistory(studentId);
                    let contentHTML = '<div style="max-height: 40vh; overflow-y: auto;">';
                    if (history.length > 0) {
                        history.forEach(record => {
                            const symbols = record.statuses.map(key => ATTENDANCE_OPTIONS.find(opt => opt.key === key)?.symbol || '').join(' ');
                            contentHTML += `<div style="padding: 0.5rem; border-bottom: 1px solid #eee;"><strong>${new Date(record.date + 'T00:00:00').toLocaleDateString('ar-EG')}</strong>: ${symbols}</div>`;
                        });
                    } else { contentHTML += '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨.</p>'; }
                    contentHTML += '</div>';
                    allSelectors.studentProfileContent.innerHTML = contentHTML;
                    openModal(allSelectors.studentProfileModalOverlay);
                }
        
                function getStudentHistory(studentId) {
                    const history = [];
                    const sortedDates = Object.keys(allDateData).sort((a, b) => new Date(b) - new Date(a));
                    sortedDates.forEach(date => {
                        if (allDateData[date][studentId] && allDateData[date][studentId].status.length > 0) {
                            history.push({ date: date, statuses: allDateData[date][studentId].status });
                        }
                    });
                    return history;
                }
        
                function checkAndDisplayNotifications() {
                    const notifications = [];
                    const sortedDates = Object.keys(allDateData).sort((a,b) => new Date(b) - new Date(a));
                    if (sortedDates.length < 1) { renderNotifications([]); return; }
                    const activeNotifRules = ATTENDANCE_OPTIONS.filter(opt => opt.notification?.enabled);
                    studentMasterList.forEach(student => {
                        activeNotifRules.forEach(rule => {
                            let consecutiveCount = 0;
                            for (const date of sortedDates) {
                                const studentData = allDateData[date]?.[student.id];
                                if (studentData?.status.includes(rule.key)) {
                                    consecutiveCount++;
                                } else {
                                    break;
                                }
                            }
                            if (consecutiveCount >= rule.notification.days) {
                                notifications.push({ type: 'warning', title: `ØªÙƒØ±Ø§Ø± Ø­Ø§Ù„Ø© "${rule.label}"`, desc: `Ø§Ù„Ø·Ø§Ù„Ø¨ ${student.name} Ù„Ø¯ÙŠÙ‡ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù€ ${consecutiveCount} Ø£ÙŠØ§Ù… Ù…ØªØªØ§Ù„ÙŠØ©.` });
                            }
                        });
                    });
                    renderNotifications(notifications);
                }
        
                function renderNotifications(notifications) {
                    allSelectors.notificationsList.innerHTML = '';
                    allSelectors.notificationCountBadge.textContent = notifications.length;
                    if (notifications.length === 0) {
                        allSelectors.notificationsList.innerHTML = '<p style="text-align: center; color: #6c757d;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª.</p>';
                        allSelectors.notificationCountBadge.style.display = 'none';
                        return;
                    }
                    allSelectors.notificationCountBadge.style.display = 'flex';
                    notifications.forEach(notif => {
                        const item = document.createElement('div');
                        item.className = 'notification-item';
                        item.innerHTML = `<div class="notification-icon" style="color: var(--warning-color);"><i class="fas fa-exclamation-triangle"></i></div><div class="notification-content"><div class="notification-title">${notif.title}</div><div>${notif.desc}</div></div>`;
                        allSelectors.notificationsList.appendChild(item);
                    });
                }
        
                function generatePrintView() {
                    const settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}');
                    const dateObj = new Date(currentDate + 'T00:00:00');
                    const formattedDate = dateObj.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
                    const groupedByStatus = {};
                    const notRecorded = [];
        
                    students.forEach(student => {
                        if (student.status && student.status.length > 0) {
                            const statusKey = student.status[0];
                            if (!groupedByStatus[statusKey]) {
                                groupedByStatus[statusKey] = [];
                            }
                            groupedByStatus[statusKey].push(student.name);
                        } else {
                            notRecorded.push(student.name);
                        }
                    });
        
                    let summaryHtml = '<h2>Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø§Ù„Ø§Øª</h2>';
                    if (Object.keys(groupedByStatus).length === 0 && notRecorded.length === students.length) {
                        summaryHtml += '<p style="text-align:center;">Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø£ÙŠ Ø­Ø§Ù„Ø© Ù„Ø£ÙŠ Ø·Ø§Ù„Ø¨.</p>';
                    } else {
                        ATTENDANCE_OPTIONS.forEach(option => {
                            const statusKey = option.key;
                            if (groupedByStatus[statusKey]) {
                                summaryHtml += `<h4>${option.symbol} ${option.label} (${groupedByStatus[statusKey].length})</h4>`;
                                summaryHtml += '<ul>';
                                groupedByStatus[statusKey].sort((a, b) => a.localeCompare(b)).forEach(name => {
                                    summaryHtml += `<li>${name}</li>`;
                                });
                                summaryHtml += '</ul>';
                            }
                        });
        
                        if (notRecorded.length > 0) {
                            summaryHtml += `<h4>Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (${notRecorded.length})</h4>`;
                            summaryHtml += '<ul>';
                            notRecorded.sort((a, b) => a.localeCompare(b)).forEach(name => {
                                summaryHtml += `<li>${name}</li>`;
                            });
                            summaryHtml += '</ul>';
                        }
                    }
                    summaryHtml += '<hr style="margin: 2rem 0;">';
        
                    let reportHtml = `
                        <html>
                        <head>
                            <title>ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø·Ù„Ø§Ø¨</title>
                            <meta charset="UTF-8">
                            <style>
                                body { font-family: 'Tajawal', sans-serif; direction: rtl; }
                                @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
                                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                                th, td { border: 1px solid #ddd; padding: 8px; text-align: right; }
                                th { background-color: #f2f2f2; }
                                h1, h2, h3 { text-align: center; }
                                h4 { border-bottom: 1px solid #eee; padding-bottom: 5px; color: #333; }
                                ul { padding-right: 20px; list-style-type: circle; }
                            </style>
                        </head>
                        <body>
                            <h1>ØªÙ‚Ø±ÙŠØ± Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
                            <h2>${(settings.institutionType || '')} ${(settings.institutionName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯')} | Ø§Ù„Ø£Ø³ØªØ§Ø°: ${settings.teacherName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</h2>
                            <h3>ØªØ§Ø±ÙŠØ®: ${formattedDate}</h3>
                            ${summaryHtml}
                            <h2 style="margin-top: 2rem;">Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h2>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
        
                    const allStudentsSorted = [...students].sort((a, b) => a.name.localeCompare(b.name));
                    
                    if (allStudentsSorted.length > 0) {
                        allStudentsSorted.forEach(student => {
                            const statusKey = student.status && student.status[0];
                            let statusText = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
                            if(statusKey){
                                const option = ATTENDANCE_OPTIONS.find(opt => opt.key === statusKey);
                                if(option) statusText = `${option.symbol} ${option.label}`;
                            }
                            
                            reportHtml += `
                                <tr>
                                    <td>${student.name}</td>
                                    <td>${statusText}</td>
                                </tr>
                            `;
                        });
                    } else {
                        reportHtml += '<tr><td colspan="2" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙˆÙ†.</td></tr>';
                    }
        
                    reportHtml += `
                                </tbody>
                            </table>
                        </body>
                        </html>
                    `;
        
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(reportHtml);
                    printWindow.document.close();
                    setTimeout(() => { // Timeout to ensure content is loaded
                        printWindow.print();
                    }, 500);
                }
        
                function generateWhatsappMessage() {
                    const templates = {
                        standard: (data) => {
                            let header = `*ØªÙ‚Ø±ÙŠØ± Ø­Ù„Ù‚Ø© ${data.settings.teacherName || ''}*\n*${(data.settings.institutionType || '')} ${(data.settings.institutionName || '')}*\n*ØªØ§Ø±ÙŠØ®: ${new Date(data.date).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}*`;
        
                            if (data.students.length === 0) {
                                return header + '\n\nÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙˆÙ† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.';
                            }
        
                            const absenceKeys = ['absent_unexcused', 'absent_excused'];
                            const presentCount = data.students.filter(s => s.status.length > 0 && !s.status.some(key => absenceKeys.includes(key))).length;
        
                            let msg = header + `\n\n*Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±: ${presentCount}* Ù…Ù† ${data.students.length}\n\n*--- Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨ ---*\n`; // Added subheading
        
                            data.students.forEach((student, i) => {
                                const statusKey = student.status && student.status[0];
                                let statusText;
        
                                if (statusKey) {
                                    const option = ATTENDANCE_OPTIONS.find(opt => opt.key === statusKey);
                                    statusText = option ? `${option.symbol} ${option.label}` : 'Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©';
                                } else {
                                    statusText = 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
                                }
                                
                                msg += `${i + 1}. ${student.name}\n   ${statusText}\n`;
                            });
        
                            return msg;
                        },
                        grouped: (data) => {
                            let header = `*ØªÙ‚Ø±ÙŠØ± Ø­Ù„Ù‚Ø© ${data.settings.teacherName || ''}*\n*${(data.settings.institutionType || '')} ${(data.settings.institutionName || '')}*\n*ØªØ§Ø±ÙŠØ®: ${new Date(data.date).toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}*`;
                    
                            if (data.students.length === 0) {
                                return header + '\n\nÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙˆÙ† ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.';
                            }
        
                            // --- ADDED: Attendance Count Logic ---
                            const absenceKeys = ['absent_unexcused', 'absent_excused'];
                            const presentCount = data.students.filter(s => s.status.length > 0 && !s.status.some(key => absenceKeys.includes(key))).length;
                            let msg = header + `\n\n*Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±: ${presentCount}* Ù…Ù† ${data.students.length}\n`;
                            // --- END ADDED ---
        
                            const groupedByStatus = {};
                            const notRecorded = [];
        
                            // Group students
                            data.students.forEach(student => {
                                if (student.status && student.status.length > 0) {
                                    const statusKey = student.status[0];
                                    if (!groupedByStatus[statusKey]) {
                                        groupedByStatus[statusKey] = [];
                                    }
                                    groupedByStatus[statusKey].push(student.name);
                                } else {
                                    notRecorded.push(student.name);
                                }
                            });
        
                            // Build the message string for students with status
                            ATTENDANCE_OPTIONS.forEach(option => {
                                const statusKey = option.key;
                                if (groupedByStatus[statusKey]) {
                                    const statusText = `*${option.symbol} ${option.label} (${groupedByStatus[statusKey].length})*`;
                                    msg += `\n${statusText}\n`;
                                    groupedByStatus[statusKey].forEach(name => {
                                        msg += `- ${name}\n`;
                                    });
                                }
                            });
        
                            // Add the "Not Recorded" group if there are any
                            if (notRecorded.length > 0) {
                                msg += `\n*Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (${notRecorded.length})*\n`;
                                notRecorded.forEach(name => {
                                    msg += `- ${name}\n`;
                                });
                            }
        
                            return msg;
                        },
                        detailed: (data) => { // This is still the old, likely broken, detailed view
                            let msg = `*ØªÙ‚Ø±ÙŠØ± Ù…ÙØµÙ„ Ù„ÙŠÙˆÙ… ${new Date(data.date).toLocaleDateString('ar-EG', { weekday: 'long' })}*\n\n`;
                            const present = data.students.filter(s => s.status.includes('present'));
                            const absent = data.students.filter(s => s.status.includes('absent'));
                            if (present.length > 0) {
                                msg += `âœ… *Ø§Ù„Ø­Ø¶ÙˆØ± (${present.length})*\n`;
                                present.forEach(s => {
                                    const details = s.status.filter(st => st !== 'present').map(key => ATTENDANCE_OPTIONS.find(opt => opt.key === key)?.label || '').join(', ');
                                    msg += `- ${s.name}` + (details ? ` (${details})\n` : '\n');
                                });
                            }
                            if (absent.length > 0) msg += `\nâŒ *Ø§Ù„ØºÙŠØ§Ø¨ (${absent.length})*\n` + absent.map(s => `- ${s.name}`).join('\n');
                            return msg;
                        },
                        summary: (data) => {
                            let msg = `*Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…*\n`;
                            ATTENDANCE_OPTIONS.forEach(option => {
                                const count = data.students.filter(s => s.status.includes(option.key)).length;
                                if (count > 0) msg += `${option.symbol} ${option.label}: ${count}\n`;
                            });
                            return msg;
                        }
                    };
                    const templateFunction = templates[allSelectors.messageTemplateSelect.value] || templates.standard;
                    const settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}');
                    const data = { students: students, date: currentDate, settings: settings };
                    allSelectors.whatsappOutput.value = templateFunction(data);
                    allSelectors.whatsappOutputSection.classList.remove('hidden');
                }                        
                                function exportToCSV() {
                                    let csvContent = '\uFEFF' + 'Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨,Ø§Ù„Ø­Ø§Ù„Ø§Øª\r\n';
                                    const sortedDates = Object.keys(allDateData).sort((a, b) => new Date(a) - new Date(b));
                                    for (const date of sortedDates) {
                                        for (const studentId in allDateData[date]) {
                                            const student = studentMasterList.find(s => s.id === studentId);
                                            if (student) {
                                                const statusLabels = allDateData[date][studentId].status.map(key => ATTENDANCE_OPTIONS.find(opt => opt.key === key)?.label || key).join('; ');
                                                csvContent += [date, student.name, `"${statusLabels}"`].join(',') + '\r\n';
                                            }
                                        }
                                    }
                                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                                    const link = document.createElement("a");
                                    const url = URL.createObjectURL(blob);
                                    link.setAttribute("href", url);
                                    link.setAttribute("download", "student_report.csv");
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                }
                        
                                        function downloadBackup() {
                                            const settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS) || '{}');
                                            const backupData = { version: "2.0", timestamp: new Date().toISOString(), settings: settings, masterList: studentMasterList, allData: allDateData, statuses: ATTENDANCE_OPTIONS };
                                            const dataStr = JSON.stringify(backupData, null, 2);
                                            const blob = new Blob([dataStr], { type: "application/json" });
                                            const url = URL.createObjectURL(blob);
                                            const a = document.createElement('a');
                                            a.href = url;
                                            a.download = `student-tracker-backup-v2-${new Date().toISOString().split('T')[0]}.json`;
                                            document.body.appendChild(a);
                                            a.click();
                                            document.body.removeChild(a);
                                        }                        
                                function handleRestore(event) {
                                    const file = event.target.files[0];
                                    if (!file) return;
                                    const reader = new FileReader();
                                    reader.onload = function(e) {
                                        try {
                                            const backupData = JSON.parse(e.target.result);
                                            if (backupData.version !== "2.0" || !backupData.masterList || !backupData.allData) throw new Error("Ù…Ù„Ù Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØºÙŠØ± Ù…ØªÙˆØ§ÙÙ‚.");
                                            if (confirm("ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
                                                studentMasterList = backupData.masterList;
                                                allDateData = backupData.allData;
                                                if (backupData.statuses) ATTENDANCE_OPTIONS = backupData.statuses;
                                                if (backupData.settings) {
                                                    allSelectors.mosqueNameInput.value = backupData.settings.mosqueName || '';
                                                    allSelectors.teacherNameInput.value = backupData.settings.teacherName || '';
                                                    saveSettings();
                                                }
                                                saveState();
                                                setCurrentDate(currentDate || new Date().toISOString().split('T')[0]);
                                                alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                                            }
                                        } catch (error) { alert('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù: ' + error.message); }
                                        allSelectors.restoreFileInput.value = '';
                                    };
                                    reader.readAsText(file);
                                }
                        
                                function generateStatisticsReport() {
                                    const startDate = allSelectors.statsStartDate.value;
                                    const endDate = allSelectors.statsEndDate.value;
                        
                                    if (!startDate || !endDate) {
                                        alert("ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©.");
                                        return;
                                    }
                        
                                    if (new Date(startDate) > new Date(endDate)) {
                                        alert("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©.");
                                        return;
                                    }
                        
                                    const stats = calculateStatistics(startDate, endDate);
                                    displayStatistics(stats, startDate, endDate);
                                }
                        
                                function calculateStatistics(startDate, endDate) {
                                    const statusCounts = {};
                                    const studentStatusCounts = {};
                                    let recordedDays = 0;
                                    const dateSet = new Set();
                        
                                    ATTENDANCE_OPTIONS.forEach(opt => statusCounts[opt.key] = 0);
                                    studentMasterList.forEach(student => {
                                        studentStatusCounts[student.id] = {};
                                        ATTENDANCE_OPTIONS.forEach(opt => studentStatusCounts[student.id][opt.key] = 0);
                                    });
                        
                                    for (const date in allDateData) {
                                        if (date >= startDate && date <= endDate) {
                                            const dayData = allDateData[date];
                                            if (Object.keys(dayData).length > 0) {
                                                dateSet.add(date);
                                                for (const studentId in dayData) {
                                                    const studentData = dayData[studentId];
                                                    if (studentData.status && studentData.status.length > 0) {
                                                        const statusKey = studentData.status[0];
                                                        if (statusCounts.hasOwnProperty(statusKey)) {
                                                            statusCounts[statusKey]++;
                                                        }
                                                        if (studentStatusCounts[studentId] && studentStatusCounts[studentId].hasOwnProperty(statusKey)) {
                                                            studentStatusCounts[studentId][statusKey]++;
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    }
                                    recordedDays = dateSet.size;
                        
                                    return { statusCounts, studentStatusCounts, recordedDays };
                                }
                        
                                function displayStatistics(stats, startDate, endDate) {
                                    const { statusCounts, studentStatusCounts, recordedDays } = stats;
                                    let output = `*ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠ Ù…Ù† ${startDate} Ø¥Ù„Ù‰ ${endDate}*\n\n`;
                                    output += `*Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: ${recordedDays}*\n\n`;
                        
                                    output += "*-- Ù†Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª --*\n";
                                    let totalStatusOccurrences = 0;
                                    for(const key in statusCounts) {
                                        totalStatusOccurrences += statusCounts[key];
                                    }
                        
                                    if (totalStatusOccurrences > 0) {
                                        ATTENDANCE_OPTIONS.forEach(opt => {
                                            const count = statusCounts[opt.key];
                                            const percentage = ((count / totalStatusOccurrences) * 100).toFixed(1);
                                            output += `${opt.symbol} ${opt.label}: ${percentage}% (${count} Ù…Ø±Ø§Øª)\n`;
                                        });
                                    } else {
                                        output += "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.\n";
                                    }
                        
                        
                                    output += "\n*-- ØªØ±ØªÙŠØ¨ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø§Øª --*\n";
                                    ATTENDANCE_OPTIONS.forEach(option => {
                                        const studentsWithStatus = [];
                                        for (const studentId in studentStatusCounts) {
                                            const count = studentStatusCounts[studentId][option.key];
                                            if (count > 0) {
                                                const student = studentMasterList.find(s => s.id === studentId);
                                                if (student) {
                                                    studentsWithStatus.push({ name: student.name, count: count });
                                                }
                                            }
                                        }
                        
                                        if (studentsWithStatus.length > 0) {
                                            output += `\n*${option.symbol} ${option.label}*\n`;
                                            studentsWithStatus.sort((a, b) => b.count - a.count);
                                            studentsWithStatus.forEach((s, index) => {
                                                output += `${index + 1}. ${s.name} (${s.count} Ù…Ø±Ø§Øª)\n`;
                                            });
                                        }
                                    });
                        
                                    allSelectors.statisticsOutput.textContent = output;
                                    allSelectors.statisticsOutput.style.display = 'block';
                                    if (totalStatusOccurrences > 0) {
                                        allSelectors.statsActionsContainer.style.display = 'flex';
                                    } else {
                                        allSelectors.statsActionsContainer.style.display = 'none';
                                    }
                                }
                        
                                function generateStatisticsLastDays() {
                                    const days = parseInt(allSelectors.statsLastDays.value, 10);
                                    if (isNaN(days) || days <= 0) {
                                        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… ØµØ­ÙŠØ­ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.");
                                        return;
                                    }
                        
                                    const endDate = new Date();
                                    const startDate = new Date();
                                    startDate.setDate(endDate.getDate() - days);
                        
                                    const formatDate = (date) => date.toISOString().split('T')[0];
                        
                                    const stats = calculateStatistics(formatDate(startDate), formatDate(endDate));
                                    displayStatistics(stats, formatDate(startDate), formatDate(endDate));
                                }
                        
                                // --- Event Listeners ---
                                allSelectors.saveSettingsBtn.addEventListener('click', saveSettings);
                                allSelectors.todayBtn.addEventListener('click', () => setCurrentDate(new Date().toISOString().split('T')[0]));
                                allSelectors.prevDayBtn.addEventListener('click', () => navigateDate(-1));
                                allSelectors.nextDayBtn.addEventListener('click', () => navigateDate(1));
                                allSelectors.currentDateInput.addEventListener('change', () => setCurrentDate(allSelectors.currentDateInput.value));
                                allSelectors.generateWhatsappBtn.addEventListener('click', generateWhatsappMessage);
                                allSelectors.exportCsvBtn.addEventListener('click', exportToCSV);
                                allSelectors.printReportBtn.addEventListener('click', generatePrintView);
                                allSelectors.backupBtn.addEventListener('click', downloadBackup);
                                allSelectors.restoreBtn.addEventListener('click', () => allSelectors.restoreFileInput.click());
                                allSelectors.restoreFileInput.addEventListener('change', handleRestore);
                                allSelectors.notificationsBtn.addEventListener('click', () => { allSelectors.notificationsSidebar.classList.add('open'); allSelectors.mainOverlay.classList.add('visible'); });
                                allSelectors.closeNotifications.addEventListener('click', () => { allSelectors.notificationsSidebar.classList.remove('open'); allSelectors.mainOverlay.classList.remove('visible'); });
                                allSelectors.manageStudentsBtn.addEventListener('click', () => { renderMasterStudentList(); openModal(allSelectors.studentModalOverlay); });
                                allSelectors.closeStudentModalBtn.addEventListener('click', () => closeModal(allSelectors.studentModalOverlay));
                                allSelectors.addStudentForm.addEventListener('submit', (e) => {
                                    e.preventDefault();
                                    const newName = allSelectors.newStudentNameInput.value.trim();
                                    if (newName && !studentMasterList.some(s => s.name === newName)) {
                                        const newStudent = {
                                            id: `student_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                                            name: newName
                                        };
                                        studentMasterList.push(newStudent);
                                        saveState();
                                        loadStudentsForDate(currentDate);
                                        renderStudents();
                                        renderMasterStudentList();
                                        allSelectors.newStudentNameInput.value = '';
                                    } else if (studentMasterList.some(s => s.name === newName)) {
                                        alert('Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
                                    }
                                });
                                allSelectors.manageStatusesBtn.addEventListener('click', () => { renderStatusesList(); openModal(allSelectors.statusesModalOverlay); });
                                allSelectors.closeStatusesModalBtn.addEventListener('click', () => closeModal(allSelectors.statusesModalOverlay));
                                allSelectors.addStatusForm.addEventListener('submit', (e) => {
                                    e.preventDefault();
                                    const label = allSelectors.newStatusLabelInput.value.trim();
                                    const symbol = allSelectors.newStatusSymbolInput.value.trim();
                                    const color = allSelectors.newStatusColorInput.value;
                                    const key = `custom_${Date.now()}`;
                                    if (label && symbol) {
                                        ATTENDANCE_OPTIONS.push({ key, label, symbol, color, notification: { enabled: false, days: 2 } });
                                        saveState();
                                        renderStatusesList();
                                        allSelectors.addStatusForm.reset();
                                    }
                                });
                                allSelectors.resetStatusesBtn.addEventListener('click', resetStatusesToDefault);
                                allSelectors.closeStudentProfileModalBtn.addEventListener('click', () => closeModal(allSelectors.studentProfileModalOverlay));
                                allSelectors.mainOverlay.addEventListener('click', () => {
                                    closeModal(allSelectors.studentModalOverlay);
                                    closeModal(allSelectors.statusesModalOverlay);
                                    closeModal(allSelectors.studentProfileModalOverlay);
                                    allSelectors.notificationsSidebar.classList.remove('open');
                                });
                        
                                allSelectors.refreshDataBtn.addEventListener('click', () => {
                                    if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø¥Ø¹Ø§Ø¯Ø© Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…ØªØµÙØ­ØŸ')) {
                                        loadState();
                                        setCurrentDate(currentDate);
                                        alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!');
                                    }
                                });
                        
                                allSelectors.factoryResetBtn.addEventListener('click', () => {
                                    if (confirm('ØªØ­Ø°ÙŠØ±: Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØ§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) {
                                        if (confirm('Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡. Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) {
                                            Object.keys(STORAGE_KEYS).forEach(key => localStorage.removeItem(STORAGE_KEYS[key]));
                                            alert('ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚. Ø³ÙŠØªÙ… Ø§Ù„Ø¢Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
                                            location.reload();
                                        }
                                    }
                                });
                        
                                allSelectors.generateStatsBtn.addEventListener('click', generateStatisticsReport);
                        
                                allSelectors.generateStatsLastDaysBtn.addEventListener('click', generateStatisticsLastDays);
                        
                                allSelectors.copyStatsBtn.addEventListener('click', () => {
                                    const textToCopy = allSelectors.statisticsOutput.textContent;
                                    if (!textToCopy) return;
                                    navigator.clipboard.writeText(textToCopy).then(() => {
                                        allSelectors.copyStatsBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
                                        setTimeout(() => {
                                            allSelectors.copyStatsBtn.innerHTML = '<i class="fas fa-copy"></i> Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
                                        }, 2000);
                                    }).catch(err => {
                                        console.error('Failed to copy stats: ', err);
                                        alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.');
                                    });
                                });
                        
                                allSelectors.shareStatsBtn.addEventListener('click', () => {
                                    const message = allSelectors.statisticsOutput.textContent;
                                    if (!message) return;
                                    const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
                                    window.open(whatsappUrl, '_blank');
                                });        allSelectors.copyWhatsappMsgBtn.addEventListener('click', () => {
            const textToCopy = allSelectors.whatsappOutput.value;
            if (!textToCopy) return;
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    allSelectors.copyWhatsappMsgBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
                    setTimeout(() => {
                        allSelectors.copyWhatsappMsgBtn.innerHTML = '<i class="fas fa-copy"></i> Ù†Ø³Ø®';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.');
                });
            } else {
                try {
                    allSelectors.whatsappOutput.select();
                    document.execCommand('copy');
                    allSelectors.copyWhatsappMsgBtn.innerHTML = '<i class="fas fa-check"></i> ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
                    setTimeout(() => {
                        allSelectors.copyWhatsappMsgBtn.innerHTML = '<i class="fas fa-copy"></i> Ù†Ø³Ø®';
                    }, 2000);
                } catch (err) {
                    console.error('Fallback copy failed: ', err);
                    alert('ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø® Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©.');
                }
            }
        });

        allSelectors.shareWhatsappBtn.addEventListener('click', () => {
            const message = allSelectors.whatsappOutput.value;
            if (!message) return;
            const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        });

        // --- Initialization ---
        loadState();
        setCurrentDate(new Date().toISOString().split('T')[0]);
    });
    </script>
</body>
</html>